<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../img/logo.png">
    <link href="https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/record.css">
    <link rel="stylesheet" href="css/logout.css">
    <title>Record</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>

<body>

<script>
// Check if user is logged in
fetch('php/getUserId.php')
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            // User is not logged in, redirect to role selection page
            window.location.href = '../role.html';
        }
    })
    .catch(error => {
        console.error('Error checking session:', error);
        window.location.href = '../role.html';
    });
</script>

    <section id="sidebar">
		<a href="#" class="brand" style="display: flex; align-items: center;">
			<img src="../img/logo.png" alt="RHULogo" class="logo">
			<span class="text">Hello BHW</span>
		</a>
        <ul class="side-menu top">
            <li>
                <a href="dashboard.html">
                    <i class="bx bxs-dashboard"></i>
                    <span class="text">Dashboard</span>
                </a>
            </li>
            <li>
                <a href="ITR.html">
                    <i class="bx bxs-user"></i>
                    <span class="text">Add New ITR</span>
                </a>
            </li>
            <li class="active">
                <a href="searchPatient.html">
                    <i class="bx bxs-notepad"></i>
                    <span class="text">Patient Records</span>
                </a>
            </li>
            <li>
                <a href="History.html">
                    <i class="bx bx-history"></i>
                    <span class="text">Referral History</span>
                </a>
            </li>
            <li>
				<a href="reports.html">
					<i class="bx bx-notepad"></i>
					<span class="text">Reports</span>
				</a>
			</li>
        </ul>
        <ul class="side-menu">
            <li>
<a href="#" class="logout" onclick="return confirmLogout()">
               <i class="bx bxs-log-out-circle"></i>
                <span class="text">Logout</span>
                </a>            </li>
        </ul>
    </section>

    <section id="content">
        <nav>
            <form action="#">
                <div class="form-input">
                    <input type="search" id="patientSearch" placeholder="Enter patient name..." name="search" autocomplete="off">
                    <button type="button" class="search-btn" id="searchButton">
                        <i class="bx bx-search"></i>
                    </button>
        
                    <div id="resultDropdown" class="dropdown-content"></div>
                    
                    <script src="js/script.js"></script>
                </div>
            </form>
            <div class="greeting">
                <span id="userGreeting">Hello BHW!</span>
            </div>
            <a href="#" class="profile">
                <img src="../img/bhw.png">
            </a>
        </nav>

        <main>
            <div class="head-title">
				<div class="left">
					<h1>Patient Records</h1>
					<ul class="breadcrumb">
						<li><a href="#">Record History</a></li>
						<li><i class="bx bx-chevron-right"></i></li>
						<a class="active" href="#" onclick="history.back(); return false;">Go back</a>

					</ul>
				</div>
			</div>
        </main>
    </section>

    <div class="patient-header-container">
        <div class="patient-name-container">
            <span class="patient-name-label">PATIENT NAME</span>
  <div class="patient-name">
                
                <div class="name-part">
                    <span class="last-name" id="last_name">Last Name</span>
                    <span class="name-label">Last Name</span>
                </div>
                <div class="name-part">
                    <span class="first-name" id="first_name">First Name</span>
                    <span class="name-label">First Name</span>
                </div>
                <div class="name-part">
                    <span class="middle-name" id="middle_name">Middle Name</span>
                    <span class="name-label">Middle Name</span>
                </div>
                <div class="name-part">
                    <span class="extension" id="extension"></span>
                    <span class="name-label">Extension</span>
                </div>
                
            </div>
        </div>

       <div class="patient-id-box" hidden>
           <div class="patient-id-container">
                <span class="patient-id-label">ID</span>
                <span class="id-number">00000</span>
            </div>
        </div> 
    </div> 

    <div class="patient-record-container">
        <main class="patient-content">
            <section class="personal-info-section">
                <h2 class="section-title">Personal Information</h2>
                <div class="detail">
                    <strong>Address:</strong> <span class="underline" id="address">N/A</span>
                </div>
                <div class="detail">
                    <strong>Age:</strong> <span class="underline" id="age">N/A</span>
                </div>
                <div class="detail">
                    <strong>Gender:</strong> <span class="underline" id="gender">N/A</span>
                </div>
                <div class="detail">
                    <strong>Date of Birth:</strong> <span class="underline" id="date_of_birth">N/A</span>
                </div>
                <div class="detail">
                    <strong>Contact:</strong> <span class="underline" id="contact">N/A</span>
                </div>
                <div class="detail">
                    <strong>Family No:</strong> <span class="underline" id="family_no">N/A</span>
                </div>
                <div class="detail">
                    <strong>Civil Status:</strong> <span class="underline" id="civil_status">N/A</span>
                </div>
                <div class="detail">
                    <strong>Birthplace:</strong> <span class="underline" id="birth_place">N/A</span>
                </div>
                <div class="detail">
                    <strong>Education:</strong> <span class="underline" id="education">N/A</span>
                </div>
                <div class="detail">
                    <strong>Occupation:</strong> <span class="underline" id="occupation">N/A</span>
                </div>
                <div class="detail">
                    <strong>Religion:</strong> <span class="underline" id="religion">N/A</span>
                </div>
                <div class="detail">
                    <strong>Birth Weight:</strong> <span class="underline" id="birth_weight">N/A</span>
                </div>
                <div class="detail">
                    <strong>PhilHealth No:</strong> <span class="underline" id="philhealth_no">N/A</span>
                </div>
                <div class="detail">
                    <strong>Category:</strong> <span class="underline" id="category">N/A</span>
                </div>
                <div class="detail">
                    <strong>4Ps:</strong> <span class="underline" id="fourps">N/A</span>
                </div>
            </section>                       
    
            <section class="patient-records-section">
                <h2 class="section-title">Individual Treatment Records</h2>
            
                <p><strong>No patient selected...</strong></p>
                 
            </section>
                  


            
            <!-- 🔹 Hidden Table (populated but not visible) -->
<table id="history-table" class="status" style="display: none;">
    <thead>
        <tr>
            <th>Date of Visit</th>
            <th>Age</th>
            <th>Chief Complaints & Vital Signs (BP, Wt, Ht, Temp, CR, RR, BMI)</th>
            <th>Diagnosis/Treatment/Medication/Instruction</th>
            <th>Remarks Consulted/Referred</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
        
        </main>

        <button type="button" class="btn-pill btn-pill--sm btn-pill--primary" id="printHistoryBtn">
  <i class="bx bx-calendar" aria-hidden="true"></i>
  <span>Print Visit Summary</span>
</button>

   <button class="btn-pill btn-pill--sm btn-pill--info" id="editBtn">
  <i class="bx bx-pencil" aria-hidden="true"></i>
  <span>Edit</span>
</button>

<button class="btn-pill btn-pill--sm btn-pill--danger" id="addITRBtn">
  <i class="bx bx-plus" aria-hidden="true"></i>
  <span>Add</span>
</button>

    </div>
    
    <script>

     
         // Get the patient_id from the URL
  const params = new URLSearchParams(window.location.search);
  const patientId = params.get('patient_id');

  // Build URLs with the patient_id
  if (patientId) {
    document.getElementById('editBtn').onclick = () => {
      window.location.href = `editPersonalInfo.html?patient_id=${patientId}`;
    };

    document.getElementById('addITRBtn').onclick = () => {
      window.location.href = `existingPatientITR.html?patient_id=${patientId}`;
    };
  } else {
    // Optionally disable buttons if patient_id is not found
        document.getElementById('printHistoryBtn').disabled = true;
    document.getElementById('editBtn').disabled = true;
    document.getElementById('addITRBtn').disabled = true;
    console.warn('No patient_id in URL');
  }

 let bhsName = 'Barangay Health Station';
        document.addEventListener("DOMContentLoaded", function() {
            // Get patient_id from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const patient_id = urlParams.get("patient_id");

            function displayOrNA(value) {
                  return (value !== null && value !== undefined && value !== "") ? value : "N/A";
                }
                function nothing(value) {
                  return (value !== null && value !== undefined && value !== "") ? value : "--";
                }

            if (patient_id) {




                
// 🔹 Fetch data from PHP file
fetch(`php/patient_summary.php?patient_id=${patient_id}`) 
    .then(response => response.json())
    .then(data => {
        console.log("Patient summary data:", data); // Add this line
        // Display patient info if needed
         // store RHU for use in print window
        bhsName = data.barangay || 'Barangay Health Station';

        const historyTableBody = document.querySelector("#history-table tbody");
        historyTableBody.innerHTML = ""; // Clear existing rows

        // 🔹 Loop through visit history
        data.history.forEach(record => {
            // Filter medicines linked to this consultation
            const relatedMedicines = data.medicines.filter(
                med => med.visit_id === record.visit_id
            );

            // Build medicines HTML block
            const medsHtml = relatedMedicines.length > 0
                ? relatedMedicines.map(med => 
                    `Medicine: ${med.medicine_name} <br>
                     Quantity: ${med.quantity_dispensed} <br>
                     Instruction: ${med.instruction}<br><br>`
                  ).join('')
                : 'No medicines dispensed';

            // Create table row
            const row = document.createElement("tr");
            row.innerHTML = `
                <td style="padding: 18px 10px;">${record.visit_date}</td>
                <td>${data.age}</td>
                <td>
                    Complaints: ${record.chief_complaints} <br>
                    BP: ${record.blood_pressure} <br>
                    Wt: ${record.weight} <br>
                    Ht: ${record.height} <br>
                    Temp: ${record.temperature} <br>
                    CR: ${record.chest_rate} <br>
                    RR: ${record.respiratory_rate} <br>
                    BMI: ${record.bmi}
                </td>
                <td> <br><br>${medsHtml}</td>
                <td>
                    Remarks: ${record.remarks || ''} <br><br>
                    BHW: ${record.referred_by || 'N/A'} <br>
                  
                </td>
            `;
            historyTableBody.appendChild(row);
        });
    })
    .catch(error => console.error('Error fetching data:', error));


                fetch(`php/patient_details.php?patient_id=${patient_id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.patient) {
                            // Populate the patient info fields
                           document.querySelector(".last-name").textContent = displayOrNA(data.patient.last_name);
document.querySelector(".first-name").textContent = displayOrNA(data.patient.first_name);
document.querySelector(".middle-name").textContent = displayOrNA(data.patient.middle_name);
document.querySelector(".extension").textContent = nothing(data.patient.extension);
document.querySelector(".id-number").textContent = displayOrNA(data.patient.patient_id);

let details = document.querySelectorAll(".detail .underline");
details[0].textContent = displayOrNA(data.patient.address);
details[1].textContent = data.patient.date_of_birth ? calculateAge(data.patient.date_of_birth) : "N/A";
details[2].textContent = displayOrNA(data.patient.sex);
details[3].textContent = displayOrNA(data.patient.date_of_birth);
details[4].textContent = displayOrNA(data.patient.contact_number);
details[5].textContent = displayOrNA(data.patient.family_serial_no);
details[6].textContent = displayOrNA(data.patient.civil_status);
details[7].textContent = displayOrNA(data.patient.birthplace);
details[8].textContent = displayOrNA(data.patient.educational_attainment);
details[9].textContent = displayOrNA(data.patient.occupation);
details[10].textContent = displayOrNA(data.patient.religion);
details[11].textContent = displayOrNA(data.patient.birth_weight);
details[12].textContent = displayOrNA(data.patient.philhealth_member_no);
details[13].textContent = displayOrNA(data.patient.category);
details[14].textContent = displayOrNA(data.patient.fourps_status);

                        }
                        
                        if (data.visit_history.length > 0) {
                        let recordsContainer = document.querySelector(".patient-records-section");

                        // Clear existing records before appending new ones
                        recordsContainer.innerHTML = `
                            <h2 class="section-title">BHS Visit History</h2>
                        `;

                        data.visit_history.forEach(visit => {
                            let recordDiv = document.createElement("div");
                            recordDiv.classList.add("record");

                            recordDiv.innerHTML = `
<div class="record-header">
    <p><strong>${formatDate(visit.visit_date)}</strong></p>
    <a href="visitInfo.html?visit_id=${visit.visit_id}" class="view-link">
        <i class="bx bx-show"></i> View <!-- Boxicon with text for 'View' -->
    </a>

</div>
<p class="last-updated">
    <small>Recorded by: <span>${visit.bhw_name || "Unknown"}</span></small>
</p>


`;



                            recordsContainer.appendChild(recordDiv);
                        });
                    } else {
                        document.querySelector(".patient-records-section").innerHTML += `
                            <p>No visit history available.</p>
                        `;
                    }
                })
                .catch(error => console.error("Error fetching patient data:", error));
        }
    });


     // 🖨️ PRINT BUTTON FUNCTIONALITY
const printBtn = document.getElementById("printHistoryBtn");

if (printBtn) {
  printBtn.addEventListener("click", function () {
    const tableBodyHTML = document.querySelector("#history-table tbody").innerHTML;

    // If no data yet, prevent empty print
    if (!tableBodyHTML.trim()) {
      alert("No visit history to print yet.");
      return;
    }

    // 🧠 Get patient info from the current page
    const patientInfo = {
      lastName: document.getElementById("last_name")?.textContent || "",
      firstName: document.getElementById("first_name")?.textContent || "",
      middleName: document.getElementById("middle_name")?.textContent || "",
      extension: document.getElementById("extension")?.textContent || "",
      familyNo: document.getElementById("family_no")?.textContent || "",
      address: document.getElementById("address")?.textContent || "",
      age: document.getElementById("age")?.textContent || "",
      gender: document.getElementById("gender")?.textContent || "",
      dateOfBirth: document.getElementById("date_of_birth")?.textContent || "",
      contact: document.getElementById("contact")?.textContent || "",
      civilStatus: document.getElementById("civil_status")?.textContent || "",
      birthPlace: document.getElementById("birth_place")?.textContent || "",
      education: document.getElementById("education")?.textContent || "",
      occupation: document.getElementById("occupation")?.textContent || "",
      religion: document.getElementById("religion")?.textContent || "",
      birthWeight: document.getElementById("birth_weight")?.textContent || "",
      philhealthNo: document.getElementById("philhealth_no")?.textContent || "",
      category: document.getElementById("category")?.textContent || "",
      fourps: document.getElementById("fourps")?.textContent || ""
    };

    // 🪟 Create a new temporary print window
    const printWindow = window.open('', '', 'width=900,height=700');
    printWindow.document.write(`
      <html>
      <head>
          
          <title>Individual Treatment Record</title>
          <style>
            @page { size: A4; margin: 18mm 16mm; }
            * { box-sizing: border-box; }
            body { font-family: Arial, Helvetica, sans-serif; font-size: 11pt; line-height: 1.3; color: #000; }
            .print-logo { width: 70px; height: 70px; object-fit: contain; display: block; margin: 0 auto 6px auto; }
            .header { text-align: center; margin-bottom: 10px; }
            .header strong { font-size: 12pt; display: block; margin-bottom: 4px; }
            .header h2 { font-size: 14pt; margin: 2px 0; font-weight: 700; }
            .header h3 { font-size: 12.5pt; margin: 4px 0 6px 0; font-weight: 700; letter-spacing: .3px; }
            .info-table { width: 100%; border-collapse: collapse; margin-top: 6px; }
            .info-table td { padding: 4px 6px; font-size: 10.5pt; vertical-align: top; }
            .treatment-table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
            .treatment-table th, .treatment-table td {
              border: 1px solid #000; padding: 6px; vertical-align: top; word-wrap: break-word; font-size: 10.5pt;
            }
            .treatment-table th { background: #f2f2f2; text-align: left; font-weight: 700; }
          </style>
      </head>
      <body>
  
    <div class="header">
          <img src="../img/RHUlogo.png" alt="RHU Logo" /> <br>
          <strong>Republic of the Philippines<br>Daet, Camarines Norte</strong>
          <h3> <span id="bhs">${bhsName}</span> </h3>
          <h3>INDIVIDUAL TREATMENT RECORD</h3>
        </div>
        <h3>Patient Information</h3>
        <table>
          <tr><td><strong>Family No:</strong> ${patientInfo.familyNo}</td></tr>
            <tr>
            <td><strong>Last Name:</strong> ${patientInfo.lastName}</td>
            <td><strong>First Name:</strong> ${patientInfo.firstName}</td>
            <td><strong>Middle Name:</strong> ${patientInfo.middleName}</td>
               <td><strong>Ext:</strong> ${patientInfo.extension}</td>
          </tr>
          <tr><td><strong>Address:</strong> ${patientInfo.address}</td></tr>
          <tr>
            <td><strong>Age:</strong> ${patientInfo.age}</td>
            <td><strong>Gender:</strong> ${patientInfo.gender}</td>
            <td><strong>Date of Birth:</strong> ${patientInfo.dateOfBirth}</td>
          </tr>
          <tr>
            <td><strong>Contact:</strong> ${patientInfo.contact}</td>
            <td><strong>Civil Status:</strong> ${patientInfo.civilStatus}</td>
            <td><strong>Birthplace:</strong> ${patientInfo.birthPlace}</td>
          </tr>
          <tr>
            <td><strong>Education:</strong> ${patientInfo.education}</td>
            <td><strong>Occupation:</strong> ${patientInfo.occupation}</td>
            <td><strong>Religion:</strong> ${patientInfo.religion}</td>
          </tr>
          <tr>
            <td><strong>Birth Weight:</strong> ${patientInfo.birthWeight}</td>
            <td><strong>PhilHealth No:</strong> ${patientInfo.philhealthNo}</td>
            <td><strong>Category:</strong> ${patientInfo.category}</td>
          </tr>
          <tr><td><strong>4Ps:</strong> ${patientInfo.fourps}</td></tr>
        </table>

        <br><br>
       
        <table id="treatment-table" class="treatment-table">
          <thead>
            <tr>
              <th>Date of Visit</th>
              <th>Age</th>
              <th>Chief Complaints & Vital Signs</th>
              <th>Diagnosis/Treatment/Medication</th>
              <th>Remarks Consulted/Referred</th>
            </tr>
          </thead>
          <tbody>
            ${tableBodyHTML}
          </tbody>
        </table>
      </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
  });
}


    function formatDate(dateString) {
        let options = { year: "numeric", month: "long", day: "numeric" };
        return new Date(dateString).toLocaleDateString("en-US", options);
    }

    function viewRecord(visitId) {
    // Redirect to visitInfo.html with visitId as a query parameter
    window.location.href = `visitInfo.html?visit_id=${visitId}`;
}


    
function calculateAge(dob) {
    let birthDate = new Date(dob);
    let today = new Date();

    let years = today.getFullYear() - birthDate.getFullYear();
    let months = today.getMonth() - birthDate.getMonth();
    let days = today.getDate() - birthDate.getDate();

    // Adjust months if days are negative
    if (days < 0) {
        months--;
    }

    // Adjust years and months if months are negative
    if (months < 0) {
        years--;
        months += 12;
    }

    if (years <= 0) {
        // If less than 1 year, show in months
        if (months <= 0) {
            return "Less than a month old";
        }
        return months + (months === 1 ? " month old" : " months old");
    } else {
        return years + (years === 1 ? " year old" : " years old");
    }
}

    </script>
    
<div id="logoutModal" class="logout-modal">
    <div class="logout-modal-content">
        <div class="logout-modal-header">
            <h3>Confirm Logout</h3>
        </div>
        <div class="logout-modal-body">
            <p>Are you sure you want to logout?</p>
        </div>
        <div class="logout-modal-footer">
            <button onclick="closeModal()" class="logout-cancel-btn">Cancel</button>
            <button onclick="proceedLogout()" class="logout-confirm-btn">Yes, Logout</button>
        </div>
    </div>
</div>    


<script>
function confirmLogout() {
    document.getElementById('logoutModal').style.display = 'block';
    return false; // Prevent the default link behavior
}

function closeModal() {
    document.getElementById('logoutModal').style.display = 'none';
}

function proceedLogout() {
		 window.location.href = '../ADMIN/php/logout.php';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('logoutModal');
    if (event.target == modal) {
        closeModal();
    }
}
fetch('php/getUserName.php')
    .then(response => response.json())
    .then(data => {
        if (data.full_name) {
            document.getElementById('userGreeting').textContent = `Hello, ${data.full_name}!`;
        } else {
            document.getElementById('userGreeting').textContent = 'Hello, BHW!';
        }
    })
    .catch(error => {
        console.error('Error fetching user name:', error);
        document.getElementById('userGreeting').textContent = 'Hello, BHW!';
    });
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const sidebar = document.getElementById("sidebar");

  function applyResponsiveSidebar() {
    if (window.innerWidth <= 1024) {
      sidebar.classList.add("hide");   // collapsed on small screens
    } else {
      sidebar.classList.remove("hide"); // expanded on larger screens
    }
  }

  applyResponsiveSidebar();
  window.addEventListener("resize", applyResponsiveSidebar);

  // keep the rest of your existing code (auth, stats, modals, etc.)
});
</script>

</body>
</html>
