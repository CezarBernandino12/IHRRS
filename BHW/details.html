<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../img/logo.png">
    <link href="https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/dashstyle.css">
    <link rel="stylesheet" href="css/details.css">
    <link rel="stylesheet" href="css/logout.css">
    <title>Referral Slip Preview</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>

<body>

    <section id="sidebar">
		<a href="#" class="brand" style="display: flex; align-items: center;">
			<img src="../img/logo.png" alt="RHULogo" class="logo">
			<span class="text">Hello BHW</span>
		</a>
        <ul class="side-menu top">
            <li>
                <a href="dashboard.html">
                    <i class="bx bxs-dashboard"></i>
                    <span class="text">Dashboard</span>
                </a>
            </li>
            <li>
                <a href="ITR.html">
                    <i class="bx bxs-user"></i>
                    <span class="text">Add New ITR</span>
                </a>
            </li>
            <li>
                <a href="searchPatient.html">
                    <i class="bx bxs-notepad"></i>
                    <span class="text">Patient Records</span>
                </a>
            </li>
            <li>
                <a href="History.html">
                    <i class="bx bx-history"></i>
                    <span class="text">Referral History</span>
                </a>
            </li>
            <li>
                <a href="reports.html">
                    <i class="bx bx-notepad"></i>
                    <span class="text">Reports</span>
                </a>
            </li>
        </ul>
        <ul class="side-menu">
            <li>
                <a href="#" class="logout" onclick="return confirmLogout()">
               <i class="bx bxs-log-out-circle"></i>
                <span class="text">Logout</span>
                </a>
            </li>
        </ul>
    </section>

    <section id="content">
        <nav>
            <form action="#">
                <div class="form-input">
                    <input type="search" id="patientSearch" placeholder="Enter patient name..." name="search" autocomplete="off">
                    <button type="button" class="search-btn" id="searchButton">
                        <i class="bx bx-search"></i>
                    </button>
                    <div id="resultDropdown" class="dropdown-content"></div>
                    <script src="js/script.js"></script>
                </div>
            </form>
            <div class="greeting">
                <span id="userGreeting">Hello BHW!</span>
            </div>
            <a href="#" class="profile">
                <img src="../img/bhw.png">
            </a>
        </nav>

        <main>
            <div class="head-title">
                <div class="left">
                    <h1>Referral Slip Preview</h1>
                    <ul class="breadcrumb">
                        <li><a href="#">Referral Slip Preview</a></li>
                        <li><i class="bx bx-chevron-right"></i></li>
                        <a class="active" href="#" onclick="history.back(); return false;">Go back</a>
                    </ul>
                </div>
            </div>
        </main>
    </section>

<!-- Modified referral-container section with optimized layout -->

<div class="referral-container">
    <a id="viewRecordLink" href="#" class="view-record-link" style="float: right;">View Record</a>
    <br>
    
<div class="referral-header">
  <img src="../img/mho_logo.png" alt="Barangay / Station Logo" class="referral-logo left" aria-hidden="true">
  
  <div class="referral-heading">
    <div class="line-1">Republic of the Philippines</div>
    <div class="line-2">Daet, Camarines Norte</div>
    <div class="line-3" id="barangay-info">Barangay 1 Health Station</div>

    <hr class="referral-rule">
    <h1 class="title">Referral Slip</h1>
  </div>

  <img src="../img/RHUlogo.png" alt="RHU Logo" class="referral-logo right" aria-hidden="true">
</div>



   
<!-- Meta strip -->
<div class="referral-meta">
  <span class="badge"><i class='bx bx-hash'></i> Referral ID: <span id="referral_id"></span></span>
  <span class="badge"><i class='bx bx-calendar'></i> Date: <span id="date"></span></span>
</div>

<!-- Patient Information -->
<div class="section-card">
  <div class="section-title">Patient Information</div>

  <div class="info-grid">
    <div class="kv">
      <span class="label">Full Name</span>
      <div id="name" class="value"></div>
    </div>
    <div class="kv">
      <span class="label">Age</span>
      <div id="age" class="value"></div>
    </div>
  </div> <br>

  <div class="info-grid">
    <div class="kv">
      <span class="label">Address</span>
      <div id="address" class="value"></div>
    </div>
    <div class="kv">
      <span class="label">Sex</span>
      <div id="sex" class="value"></div>
    </div>
    <div class="kv" hidden>
      <span class="label">Date of Birth</span>
      <div id="date_of_birth" class="value"></div>
    </div>
  </div>
</div>

<!-- Vital Signs -->
<div class="section-card">
  <div class="section-title">Vital Signs</div>

  <div class="info-grid vitals-grid">
    <div class="kv">
      <span class="label">Weight</span>
      <div id="weight" class="value"></div>
    </div>
    <div class="kv">
      <span class="label">Height</span>
      <div id="height" class="value"></div>
    </div>
    <div class="kv">
      <span class="label">Blood Pressure</span>
      <div id="bp" class="value"></div>
    </div>
    <div class="kv">
      <span class="label">Temperature</span>
      <div id="temp" class="value"></div>
    </div>
  </div>
</div>

<!-- Chief Complaints -->
<div class="section-card">
  <div class="section-title">Chief Complaints</div>
  <div id="complaints" class="textbox"></div>
</div>

<!-- Diagnosis -->
<div class="section-card">
  <div class="section-title">Diagnosis <span class="lock-note">(To be filled out by the doctor only. Do not write anything.)</span></div>
  <div class="textbox" id="diagnosisBox">
    <div class="field-value diagnosis-field"></div>
  </div>
</div>

<!-- Medications / Treatment -->
<div class="section-card">
  <div class="section-title">Medications / Treatment <span class="lock-note">(To be filled out by the doctor only. Do not write anything.)</span></div>
  <div class="treatment-container">
    <textarea readonly rows="4" aria-label="Medications and treatment (read only)"></textarea>
  </div>
</div>

<!-- Signature -->

  
<div class="signature-container">
  <div style="font-size: 16px; font-weight: bolder;">Signature</div>
      <div class="line"></div>
    <span class="name" id="bhwName">Barangay Health Worker</span>
    <div class="section-title">Barangay Health Worker</div>
  </div>




<input type="hidden" id="visit-id" name="visit_id">

<!-- Footer buttons (unchanged) -->
<div class="referral-form-footer">
  <button id="goBackBtn" class="footer-btn">Back to dashboard</button>
<button id="printBtn" class="footer-btns print-pill" type="button" title="Print">
  <i class='bx bxs-printer' aria-hidden="true"></i>
  <span>Print</span>
</button>

</div>


<!-- Keep the existing JavaScript unchanged -->
        <script>
            const params = new URLSearchParams(window.location.search);
            const referralId = params.get('referral_id');
    
            if (referralId) {
                // First fetch user's barangay
                fetch('php/getUserId.php')
                    .then(response => response.json())
                    .then(userData => {
                        if (userData.barangay) {
                            document.getElementById('barangay-info').textContent = userData.barangay;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching user data:', error);
                    });

                // Then fetch referral details
                fetch(`php/getReferralDetails.php?referral_id=${referralId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Received data:', data); // Debug log
                        if (data.error) {
                            alert(data.error);
                            return;
                        }

                        // Update the View Record link with visit_id
                        if (data.visit_id) {
                            const viewRecordLink = document.getElementById('viewRecordLink');
                            viewRecordLink.href = `visitInfo.html?visit_id=${data.visit_id}`;
                        } else {
                            console.error('No visit_id found in referral data');
                            document.getElementById("viewRecordLink").style.display = 'none'; // Hide link if no visit_id
                        }

                        document.getElementById('referral_id').textContent = data.referral_id || '';
                        document.getElementById('date').textContent = data.referral_date || '';
                        document.getElementById('name').textContent = data.name || '';

                        document.getElementById('date_of_birth').textContent = data.date_of_birth || '';

                        // Calculate age from date_of_birth
if (data.date_of_birth) {
    let birthDate = new Date(data.date_of_birth);
    let today = new Date();

    let years = today.getFullYear() - birthDate.getFullYear();
    let months = today.getMonth() - birthDate.getMonth();
    let days = today.getDate() - birthDate.getDate();

    // Adjust months if negative
    if (days < 0) {
        months--;
    }

    // Adjust years if birthday hasn’t occurred yet this year
    if (months < 0) {
        years--;
        months += 12;
    }

    let ageText = "";
    if (years > 0) {
        ageText = years + " year" + (years > 1 ? "s" : "");
    } else {
        ageText = months + " month" + (months > 1 ? "s" : "");
    }

    document.getElementById('age').textContent = ageText;
} else {
    document.getElementById('age').textContent = '';
}

                        document.getElementById('address').textContent = data.address || '';
                        document.getElementById('sex').textContent = data.sex || '';
                        document.getElementById('weight').textContent = data.weight + ' kg';
                        document.getElementById('height').textContent = data.height + ' cm';
                        
                        document.getElementById('bp').textContent = data.blood_pressure || '';
                        document.getElementById('temp').textContent = data.temperature + ' °C';
                        console.log('Chief complaints value:', data.chief_complaints); // Debug log
                        document.getElementById('complaints').textContent = data.chief_complaints || '';
                        
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });
            } else {
                alert("No referral ID provided in URL.");
            }
        </script>
    <script>
        function getReferralIdFromURL() {
            let params = new URLSearchParams(window.location.search);
            let referralId = params.get('referral_id');

            if (!referralId) {
                alert("❌ Error: No referral ID found in the URL.");
                return null;
            }

            return referralId;
        }

        document.getElementById('goBackBtn').onclick = function () {
            // Replace with your actual dashboard URL
            window.location.href = 'dashboard.html';
        };

        document.getElementById('printBtn').onclick = function () {
            window.print();
        };
    </script>

<div id="logoutModal" class="logout-modal">
    <div class="logout-modal-content">
        <div class="logout-modal-header">
            <h3>Confirm Logout</h3>
        </div>
        <div class="logout-modal-body">
            <p>Are you sure you want to logout?</p>
        </div>
        <div class="logout-modal-footer">
            <button onclick="closeModal()" class="logout-cancel-btn">Cancel</button>
            <button onclick="proceedLogout()" class="logout-confirm-btn">Yes, Logout</button>
        </div>
    </div>
</div>

<script>
function confirmLogout() {
    document.getElementById('logoutModal').style.display = 'block';
    return false; // Prevent the default link behavior
}

function closeModal() {
    document.getElementById('logoutModal').style.display = 'none';
}

function proceedLogout() {
		 window.location.href = '../ADMIN/php/logout.php';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('logoutModal');
    if (event.target == modal) {
        closeModal();
    }
}
fetch('php/getUserName.php')
    .then(response => response.json())
    .then(data => {
        if (data.full_name) {
            document.getElementById('userGreeting').textContent = `Hello, ${data.full_name}!`;
            document.getElementById('bhwName').textContent = data.full_name; // Update BHW name in details
        } else {
            document.getElementById('userGreeting').textContent = `Hello, ${data.full_name}!`;
        }
    })
    .catch(error => {
        console.error('Error fetching user name:', error);
        document.getElementById('userGreeting').textContent = 'Hello, BHW!';
    });
</script>

<script>
(function(){
  const mmToPx = mm => (mm / 25.4) * 96; // approx at 96dpi

  function fitToA4Once(){
    const card = document.querySelector(".referral-container");
    if (!card) return;

    const printable = mmToPx(297 - 12); // 6mm top + 6mm bottom

    // reset transform then measure
    card.style.transform = "";
    card.style.width = "";

    const h = card.getBoundingClientRect().height;
    if (h <= printable) return;

    // compute scale (floor 0.86 to keep readable), then apply
    const scale = Math.max(0.86, Math.min(1, printable / h));
    card.style.transformOrigin = "top left";
    card.style.transform = `scale(${scale})`;
    card.style.width = `calc(100% / ${scale})`;
  }

  // Run right before printing / when print preview opens
  const mq = window.matchMedia && window.matchMedia("print");
  if (mq) {
    (mq.addEventListener || mq.addListener).call(mq, "change", e => { if (e.matches) fitToA4Once(); });
  }
  window.addEventListener("beforeprint", fitToA4Once);
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const sidebar = document.getElementById("sidebar");

  function applyResponsiveSidebar() {
    if (window.innerWidth <= 1024) {
      sidebar.classList.add("hide");   // collapsed on small screens
    } else {
      sidebar.classList.remove("hide"); // expanded on larger screens
    }
  }

  applyResponsiveSidebar();
  window.addEventListener("resize", applyResponsiveSidebar);

  // keep the rest of your existing code (auth, stats, modals, etc.)
});
</script>

</body>
</html>